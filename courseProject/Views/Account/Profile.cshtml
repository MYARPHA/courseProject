@model courseProject.Models.ProfileViewModel
@{
    ViewData["Title"] = "Профиль";
}

<div class="page-header d-flex justify-content-between align-items-center">
    <h1 class="page-title">Профиль</h1>
    <a asp-action="Edit" class="btn btn-dark">Редактировать профиль</a>
</div>

<div class="card mb-4">
    <div class="card-body d-flex gap-4 align-items-center">
        <div id="avatarPreview" style="width:96px;height:96px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#f1f1f1;">
            @if (!string.IsNullOrEmpty(Model.User.AvatarPath))
            {
                <img src="@Model.User.AvatarPath" alt="avatar" style="width:96px;height:96px;object-fit:cover;" />
            }
            else
            {
                <div id="avatarPlaceholder" style="font-size:36px;padding:6px;"></div>
            }
        </div>
        <div>
            <div><strong>Email:</strong> @Model.User.Email</div>
            <div><strong>Имя:</strong> @Model.User.FullName</div>
            <div class="text-muted">Роль: @Model.User.Role</div>
        </div>
    </div>
</div>

@* Request list: show user's requests with status and totals *@
@if (Model.Requests != null && Model.Requests.Any())
{
    <div class="card">
        <div class="card-body">
            <h5 class="mb-3">Мои заявки</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Дата</th>
                            <th>Позиции</th>
                            <th>Сумма</th>
                            <th>Статус</th>
                            <th>Ответственный</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var idx = 1;
                        }
                        @foreach (var r in Model.Requests)
                        {
                            <tr>
                                <td>@idx</td>
                                <td>@(r.CreatedAt.ToString("dd MMM yyyy"))</td>
                                <td>
                                    @if (r.Items != null && r.Items.Any())
                                    {
                                        <span class="small text-muted">@r.Items.Count() поз.</span>
                                    }
                                    else
                                    {
                                        <span class="small text-muted">—</span>
                                    }
                                </td>
                                <td>@(r.Total.ToString("C"))</td>
                                <td>
                                    <span class="badge bg-secondary">@r.Status</span>
                                </td>
                                <td>@(string.IsNullOrWhiteSpace(r.AssignedTo) ? "—" : r.AssignedTo)</td>
                            </tr>
                            idx++;
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-info">У вас пока нет заявок.</div>
}

@section Scripts {
    <script>
        // show saved avatar (from server) or local selection
        (function(){
            const preview = document.getElementById('avatarPreview');
            // if server-provided img exists, nothing to do. otherwise show localStorage emoji
            const img = preview.querySelector('img');
            if (!img) {
                const ls = localStorage.getItem('userAvatar');
                if (ls) {
                    const ph = document.getElementById('avatarPlaceholder');
                    if (ph) ph.innerText = ls;
                }
            }
        })();
    </script>
}
